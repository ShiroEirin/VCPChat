# Flowlock (心流锁) 模块

## 📖 概述

**Flowlock（心流锁）** 是 VCPChat 的一个强大功能模块，它能让 Agent 进入自动续写模式。在此模式下，Agent 的每次回复结束后都会自动触发续写功能，形成连续不断的创作流，让 AI 可以持续输出内容而无需人工干预。

## ✨ 核心特性

### 🔄 自动续写循环
- Agent 完成一次回复后自动触发下一次续写
- 形成连续的创作流，无需手动干预
- 支持自定义续写提示词

### 🛡️ 健壮性保证
- **智能重试机制**：续写失败时自动重试，最多3次
- **异常处理**：重试次数用尽后自动停止心流锁
- **状态保护**：防止在非完成状态的消息上触发续写

### 💫 视觉反馈
- **发光效果**：心流锁启动时，"与 XX 聊天中" 标题会持续发光
- **脉冲动画**：底色呼吸式脉冲，清晰指示当前状态
- **状态指示器**：可选的小圆点闪烁提示

### 🎮 灵活控制
- **右键菜单启动**：右键点击 "与 XX 聊天中" 启用心流锁
- **中键快速启动**：中键点击 "与 XX 聊天中" 启用并立即开始续写
- **中键快速停止**：心流锁运行时中键点击标题即可停止
- **快捷键控制**：`Command/Ctrl + G` 快速停止心流锁

### 🔌 插件集成
- **后端插件支持**：通过分布式服务器插件实现 Agent 自主控制
- **四大核心方法**：
  - `start` - Agent 启动心流锁
  - `stop` - Agent 停止心流锁
  - `promptee` - Agent 自定义续写提示词
  - `prompter` - Agent 设置外部提示词来源

## 🚀 使用方法

### 用户操作

#### 方法 1：右键菜单启动
1. 在聊天界面，右键点击顶部的 "与 XX 聊天中" 文字
2. 从上下文菜单选择 "启动心流锁"
3. 心流锁启动，标题开始发光

#### 方法 2：中键快速启动（推荐）
1. 中键点击 "与 XX 聊天中" 文字
2. 心流锁立即启动并开始第一次续写
3. Agent 将持续自动续写

#### 停止心流锁
**方法 1：中键点击**
- 在心流锁运行时，中键点击发光的 "与 XX 聊天中" 即可停止

**方法 2：快捷键**
- 按 `Command + G` (macOS) 或 `Ctrl + G` (Windows/Linux)

**注意**：停止心流锁不会中断正在进行的续写，两者功能独立。如需中断续写，请右键点击消息气泡选择"中止回复"。

### Agent 自主控制

Agent 可以通过调用 Flowlock 插件来控制续写行为：

#### 1. 启动心流锁
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」Flowlock「末」,
command:「始」start「末」,
agentId:「始」current_agent_id「末」,
topicId:「始」current_topic_id「末」,
immediate:「始」true「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 2. 停止心流锁
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」Flowlock「末」,
command:「始」stop「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 3. 设置自定义提示词
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」Flowlock「末」,
command:「始」promptee「末」,
prompt:「始」请继续深入分析这个问题，并提供更多细节「末」
<<<[END_TOOL_REQUEST]>>>
```

#### 4. 设置外部提示词来源
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」Flowlock「末」,
command:「始」prompter「末」,
source:「始」external_api_endpoint「末」,
params:「始」{"key": "value"}「末」
<<<[END_TOOL_REQUEST]>>>
```

## 🎯 最佳实践与使用场景

### 💎 推荐搭配

#### 1. Flowlock + WaitingForUrReply
**场景**：AI 连续创作时需要用户确认
```
Agent 创作第一部分 → 触发 WaitingForUrReply 询问用户 → 
用户确认后 → 继续下一部分创作 → 循环
```

**优势**：
- AI 可以持续输出，但在关键节点征求用户意见
- 实现人机协同创作
- 避免 AI 偏离用户期望

#### 2. Flowlock + Canvasmodules
**场景**：代码/文档的迭代开发

```
Agent 在 Canvas 中写代码 → 自动续写优化 → 
持续重构和改进 → 形成完整项目
```

**优势**：
- AI 可以像真实开发者一样持续迭代
- Canvas 提供版本控制和回溯
- 适合复杂的代码项目开发

### 📚 典型应用场景

#### 1. 长篇内容创作
- **小说写作**：Agent 持续输出章节内容
- **技术文档**：自动生成详细的技术手册
- **报告生成**：持续输出分析报告的各个部分

#### 2. 代码开发
- **项目搭建**：从零开始持续构建完整项目
- **代码重构**：逐步优化和改进代码质量
- **文档生成**：为代码自动生成完整文档

#### 3. 教学辅导
- **知识讲解**：持续深入讲解复杂概念
- **练习题生成**：自动生成系列练习题
- **答疑解惑**：层层递进解答问题

#### 4. 创意构思
- **头脑风暴**：持续产生创意想法
- **方案设计**：逐步完善设计方案
- **策略规划**：层层展开战略规划

### ⚠️ 注意事项

1. **Token 消耗**：心流锁会持续调用 AI，注意 Token 使用量
2. **内容质量**：长时间运行可能导致内容质量下降，建议适时停止
3. **上下文限制**：注意 Agent 的上下文窗口限制
4. **手动干预**：可随时使用中键或快捷键停止

## 🔧 技术实现

### 架构组成

```
前端模块 (Flowlockmodules/)
├── flowlock.js          # 核心逻辑
├── flowlock.css         # 发光效果样式
└── README.md           # 本文档

后端插件 (VCPDistributedServer/Plugin/Flowlock/)
├── flowlock.js                # 插件实现
├── plugin-manifest.json       # 插件清单
└── ../../appdata/flowlock-state.json  # 状态文件
```

### 工作流程

1. **启动阶段**
   - 用户或 Agent 触发启动
   - 前端模块激活，UI 开始发光
   - 后端插件记录状态

2. **运行阶段**
   - 监听消息完成事件
   - 自动触发续写功能
   - 失败时智能重试（最多3次）

3. **停止阶段**
   - 用户手动停止或 Agent 调用停止
   - 前端停止发光效果
   - 后端清除状态

### 错误处理

```javascript
续写失败
  ↓
重试计数 + 1
  ↓
重试计数 < 3 ?
  ↙        ↘
 是         否
  ↓          ↓
等待2秒    停止心流锁
  ↓        显示错误
重新续写
```

## 📝 更新日志

### v1.0.0 (2025-01-27)
- ✨ 初始版本发布
- ✅ 实现核心自动续写功能
- ✅ 实现右键/中键交互
- ✅ 实现发光效果
- ✅ 实现智能重试机制（3次）
- ✅ 实现后端同步插件
- ✅ 支持 Agent 自主控制
- ✅ 支持快捷键 Command/Ctrl + G

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

本模块遵循 VCPChat 项目的许可证。